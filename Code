import pandas as pd
import numpy as np
import yfinance as yf
!pip install evds
from evds import evdsAPI
import seaborn as sns
import matplotlib.pyplot as plt
from xgboost import XGBRegressor
import shap  # pip install shap
from sklearn.metrics import mean_squared_error, r2_score
import warnings

warnings.filterwarnings('ignore')

print("Veriler toplanıyor, lütfen bekleyiniz...")

api_key = 'BURAYA KENDİ APİ KEY İNİZİ GİRİN'
evds = evdsAPI(api_key)

tr_series = ['TP.FG.J0', 'TP.KTF10', 'TP.AB.C2']

df_tr = evds.get_data(tr_series, startdate="01-01-2015", enddate="01-01-2026")

df_tr.rename(columns={
    'TP_FG_J0': 'Enflasyon',
    'TP_KTF10': 'Faiz',
    'TP_AB_C2': 'Rezervler',
    'Tarih': 'Date'
}, inplace=True)

df_tr['Date'] = pd.to_datetime(df_tr['Date'])
df_tr.set_index('Date', inplace=True)

global_tickers = ['TRY=X', 'DX-Y.NYB']
df_global = yf.download(global_tickers, start="2015-01-01", end="2026-01-01")['Close']
df_global.columns = ['DXY', 'Dolar_TL']

df_global_monthly = df_global.resample('MS').mean()

try:
    df_cds = pd.read_csv('TR_CDS.csv')
    df_cds['Date'] = pd.to_datetime(df_cds['Tarih'], dayfirst=True)

    if df_cds['Şimdi'].dtype == 'object':
        df_cds['CDS'] = df_cds['Şimdi'].str.replace('.', '', regex=False).str.replace(',', '.', regex=False).astype(float)
    else:
        df_cds['CDS'] = df_cds['Şimdi']

    df_cds.set_index('Date', inplace=True)
    df_cds_monthly = df_cds['CDS'].resample('MS').mean()

    df_global_monthly = df_global_monthly.join(df_cds_monthly)
    print("CDS verisi başarıyla dosyadan okundu.")

except Exception as e:
    print("UYARI: CDS dosyası bulunamadı. Analiz devam etsin diye temsili veri üretiliyor.")
    df_global_monthly['CDS'] = df_global_monthly['Dolar_TL'] * 40 + np.random.normal(0, 20, len(df_global_monthly))

df_final = df_global_monthly.join(df_tr, how='inner')
df_final = df_final.ffill().bfill() 

print("Değişkenler türetiliyor...")

df_final['Hedef_Getiri'] = df_final['Dolar_TL'].pct_change().shift(-1) * 100

df_final['Reel_Faiz_Farki'] = df_final['Faiz'] - df_final['Enflasyon']

df_final['Dolar_Getiri_1Ay'] = df_final['Dolar_TL'].pct_change() * 100

df_final['Volatilite'] = df_final['Dolar_TL'].pct_change().rolling(3).std()

df_final['Rezerv_Degisim'] = df_final['Rezervler'].pct_change() * 100
df_final['CDS_Degisim'] = df_final['CDS'].pct_change() * 100
df_final['DXY_Degisim'] = df_final['DXY'].pct_change() * 100

df_model = df_final.dropna()

features = ['Reel_Faiz_Farki', 'Enflasyon', 'Rezerv_Degisim',
            'CDS_Degisim', 'DXY_Degisim', 'Dolar_Getiri_1Ay', 'Volatilite']

X = df_model[features]
y = df_model['Hedef_Getiri']

split = int(len(X) * 0.85)
X_train, X_test = X.iloc[:split], X.iloc[split:]
y_train, y_test = y.iloc[:split], y.iloc[split:]

print(f"Model eğitiliyor... (Eğitim Seti: {len(X_train)} ay)")

model = XGBRegressor(
    n_estimators=500,
    learning_rate=0.02,
    max_depth=4,
    random_state=42
)

model.fit(X_train, y_train)

y_pred_pct = model.predict(X_test)

actual_prices = df_model['Dolar_TL'].iloc[split:].values
prev_prices = df_model['Dolar_TL'].iloc[split-1 : split + len(y_test) - 1].values

pred_prices = prev_prices * (1 + y_pred_pct / 100)

rmse = np.sqrt(mean_squared_error(actual_prices, pred_prices))
r2 = r2_score(actual_prices, pred_prices)

print(f"\n--- MODEL PERFORMANSI (TEST SETİ) ---")
print(f"RMSE (TL Bazında Hata Payı): {rmse:.2f} TL")
print(f"R2 Skoru (Açıklayıcılık): {r2:.2f}")

y_pred_pct_train = model.predict(X_train)
actual_prices_train = df_model['Dolar_TL'].iloc[:split].values

idx_start_model_in_df_final = df_final.index.get_loc(df_model.index[0])
prev_prices_train = df_final['Dolar_TL'].iloc[idx_start_model_in_df_final - 1 : idx_start_model_in_df_final - 1 + len(X_train)].values

pred_prices_train = prev_prices_train * (1 + y_pred_pct_train / 100)

rmse_train = np.sqrt(mean_squared_error(actual_prices_train, pred_prices_train))
r2_train = r2_score(actual_prices_train, pred_prices_train)

print(f"\n--- MODEL PERFORMANSI (EĞİTİM SETİ) ---")
print(f"RMSE (TL Bazında Hata Payı): {rmse_train:.2f} TL")
print(f"R2 Skoru (Açıklayıcılık): {r2_train:.2f}")

print("\n--- OVERFITTING KONTROLÜ ---")
if r2_train > r2 and (r2_train - r2) > 0.10:
    print("Model eğitim setinde test setine göre belirgin şekilde daha iyi performans gösteriyor.")
    print("Bu durum overfitting belirtisi olabilir. Model, eğitim verilerine aşırı uyum sağlamış ve genelleme yeteneğini kaybetmiş olabilir.")
    print("Daha fazla düzenleme (regularization), daha fazla veri veya model karmaşıklığını azaltma gibi yöntemler denenebilir.")
else:
    print("Modelin eğitim ve test seti performansları yakın görünüyor. Belirgin bir overfitting belirtisi yok.")


y_pred_pct_full = model.predict(X) # 

start_idx_df_model_in_df_final = df_final.index.get_loc(df_model.index[0])
prev_prices_full = df_final['Dolar_TL'].iloc[start_idx_df_model_in_df_final - 1 : start_idx_df_model_in_df_final - 1 + len(df_model)].values

actual_prices_full = df_model['Dolar_TL'].values
pred_prices_full = prev_prices_full * (1 + y_pred_pct_full / 100)

plt.figure(figsize=(14, 7))
plt.plot(df_model.index, actual_prices_full, label='Gerçek Kur', color='blue', linewidth=2)
plt.plot(df_model.index, pred_prices_full, label='Model Tahmini', color='red', linestyle='--', linewidth=2)
plt.title('Dolar Kuru Tahmin Grafiği (2015-Güncel)')
plt.xlabel('Tarih')
plt.ylabel('Dolar Kuru (TL)')
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()

print("\nSHAP Analizi (Değişkenlerin Etkisi) çiziliyor...")
explainer = shap.Explainer(model)
shap_values = explainer(X_test)

plt.figure(figsize=(10, 6))
plt.title("Hangi Veri Kuru Nasıl Etkiliyor?")
shap.summary_plot(shap_values, X_test, show=True)

last_row = df_final.iloc[[-1]][features]
next_pct_change = model.predict(last_row)[0]

current_price = df_final['Dolar_TL'].iloc[-1]
next_price = current_price * (1 + next_pct_change/100)

print(f"\n--- GELECEK AY PROJEKSİYONU ---")
print(f"Mevcut Dolar Kuru: {current_price:.2f} TL")
print(f"Modelin Öngördüğü Değişim: %{next_pct_change:.2f}")
print(f"TAHMİNİ KUR: {next_price:.2f} TL")
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
from xgboost import XGBRegressor
from sklearn.metrics import mean_squared_error, r2_score

df_model = df_final.copy()

df_model['Enflasyon_Trend'] = df_model['Enflasyon'].rolling(window=3).mean()
df_model['CDS_Trend'] = df_model['CDS'].rolling(window=3).mean()
df_model['Rezerv_Trend'] = df_model['Rezervler'].rolling(window=3).mean()
df_model['Reel_Faiz_Trend'] = df_model['Reel_Faiz_Farki'].rolling(window=3).mean()

df_model['Hedef_Getiri'] = df_model['Dolar_TL'].pct_change().shift(-1) * 100

df_model['Enflasyon_Gecikmeli'] = df_model['Enflasyon'].shift(1)
df_model['CDS_Gecikmeli'] = df_model['CDS'].shift(1)

df_model.dropna(inplace=True)

features_smooth = ['Reel_Faiz_Trend', 'Enflasyon_Trend', 'Rezerv_Trend', 
                   'CDS_Trend', 'Enflasyon_Gecikmeli', 'CDS_Gecikmeli']

X = df_model[features_smooth]
y = df_model['Hedef_Getiri']

split = int(len(X) * 0.85)
X_train, X_test = X.iloc[:split], X.iloc[split:]
y_train, y_test = y.iloc[:split], y.iloc[split:]

model_smooth = XGBRegressor(
    n_estimators=500,
    learning_rate=0.015,  
    max_depth=3,          
    subsample=0.6,        
    random_state=42
)

model_smooth.fit(X_train, y_train)

y_pred_full = model_smooth.predict(X)

start_idx = df_final.index.get_loc(df_model.index[0])
prev_prices = df_final['Dolar_TL'].iloc[start_idx - 1 : start_idx - 1 + len(df_model)].values
actual_prices = df_model['Dolar_TL'].values
pred_prices = prev_prices * (1 + y_pred_full / 100)

plot_df = pd.DataFrame({
    'Date': df_model.index,
    'Gercek': actual_prices,
    'Tahmin': pred_prices,
    'Yil': df_model.index.year
})

years = plot_df['Yil'].unique()
num_years = len(years)
cols = 3
rows = (num_years // cols) + (1 if num_years % cols > 0 else 0)

fig, axes = plt.subplots(rows, cols, figsize=(20, 5 * rows))
axes = axes.flatten()

for i, year in enumerate(years):
    ax = axes[i]
    data_year = plot_df[plot_df['Yil'] == year]
    
    rmse_year = np.sqrt(mean_squared_error(data_year['Gercek'], data_year['Tahmin']))
    
    ax.plot(data_year['Date'], data_year['Gercek'], label='Gerçek Piyasa', color='#1f77b4', linewidth=3, alpha=0.8)
    
    ax.plot(data_year['Date'], data_year['Tahmin'], label='Model Tahmini', color='#d62728', linestyle='--', linewidth=2.5)
    
    ax.set_title(f"{year} (Hata: ±{rmse_year:.2f} TL)", fontsize=12, fontweight='bold')
    ax.grid(True, alpha=0.2, linestyle='--')
    ax.xaxis.set_major_formatter(mdates.DateFormatter('%b'))
    
    if year >= 2024:
        ax.text(0.05, 0.95, "Adil Değer vs Piyasa", transform=ax.transAxes, 
                fontsize=9, verticalalignment='top', bbox=dict(boxstyle='round', facecolor='yellow', alpha=0.2))

    if i == 0:
        ax.legend(loc='upper left')

for j in range(i + 1, len(axes)):
    fig.delaxes(axes[j])

plt.tight_layout()
plt.subplots_adjust(top=0.94)
plt.suptitle('Dolar Kuru Tahmini (Trend Odaklı & Düzeltilmiş Model)', fontsize=18)
plt.show()

print(f"Genel R2 Skoru: {r2_score(actual_prices, pred_prices):.2f}")
train_rmse = np.sqrt(mean_squared_error(y_train, model_smooth.predict(X_train)))
test_rmse = np.sqrt(mean_squared_error(y_test, model_smooth.predict(X_test)))

print(f"Eğitim Seti Hata Payı (RMSE): {train_rmse:.2f}")
print(f"Test Seti Hata Payı (RMSE):   {test_rmse:.2f}")

if test_rmse > train_rmse * 1.5:
    print("DİKKAT: Test hatası eğitim hatasından %50 daha fazla. Hafif overfitting olabilir.")
else:
    print("DURUM: Gayet iyi. Eğitim ve Test hataları dengeli.")

print("\n--- OCAK 2026 PROJEKSİYONU HESAPLANIYOR ---")

last_3_months = df_final.iloc[-3:].copy()

last_3_months['Reel_Faiz_Farki'] = last_3_months['Faiz'] - last_3_months['Enflasyon']

input_data = {
    'Reel_Faiz_Trend': last_3_months['Reel_Faiz_Farki'].mean(),
    'Enflasyon_Trend': last_3_months['Enflasyon'].mean(),
    'Rezerv_Trend': last_3_months['Rezervler'].mean(),
    'CDS_Trend': last_3_months['CDS'].mean(),
    
    'Enflasyon_Gecikmeli': last_3_months['Enflasyon'].iloc[-2],
    'CDS_Gecikmeli': last_3_months['CDS'].iloc[-2]
}

X_new = pd.DataFrame([input_data])

pred_pct_change = model_smooth.predict(X_new)[0]

current_price = df_final['Dolar_TL'].iloc[-1]  # Aralık 2025 Kuru
predicted_price = current_price * (1 + pred_pct_change / 100)

rmse_test = np.sqrt(mean_squared_error(y_test, model_smooth.predict(X_test)))
margin_error = predicted_price * (rmse_test / 100) 

print("-" * 40)
print(f"Mevcut Kur (Aralık Sonu): {current_price:.2f} TL")
print(f"Modelin Öngördüğü Değişim: %{pred_pct_change:.2f}")
print("-" * 40)
print(f"OCAK 2026 TAHMİNİ: {predicted_price:.2f} TL")
print(f"Beklenen Aralık:   {predicted_price - margin_error:.2f} TL - {predicted_price + margin_error:.2f} TL")
print("-" * 40)

plt.figure(figsize=(8, 5))
bars = plt.bar(['Mevcut (Ara 2025)', 'Tahmin (Oca 2026)'], 
        [current_price, predicted_price], 
        color=['gray', 'crimson'])

for bar in bars:
    yval = bar.get_height()
    plt.text(bar.get_x() + bar.get_width()/2, yval + 0.1, f"{yval:.2f}", ha='center', fontweight='bold')

plt.title('Gelecek Ay Kur Tahmini')
plt.ylabel('Dolar/TL')
plt.ylim(current_price * 0.9, predicted_price * 1.05) 
plt.grid(axis='y', alpha=0.3)
plt.show()

print("\nModel bu kararı verirken en çok neye dikkat etti?")
importance = pd.Series(model_smooth.feature_importances_, index=features_smooth)
print(importance.sort_values(ascending=False))
senaryo = {
    'Aylik_Enflasyon_Ort': 2.5,   
    'Faiz_Politikasi': 50.0,      
    'CDS_Degisim_Ort': -1.0,      
    'Rezerv_Degisim_Ort': 0.5,    
    'DXY_Degisim_Ort': 0.0        

print(f"\n--- 2026 OCAK TAHMİN SİMÜLASYONU BAŞLIYOR ---")
print(f"Senaryo: Aylık Enflasyon %{senaryo['Aylik_Enflasyon_Ort']}, Faiz %{senaryo['Faiz_Politikasi']}")

df_future = df_final.copy()
current_date = df_future.index[-1]
target_date = pd.Timestamp('2026-01-01')

while current_date < target_date:
    current_date = current_date + pd.DateOffset(months=1)
    
    last_row = df_future.iloc[-1]
    prev_row = df_future.iloc[-2] 
    
    new_row = {}
    
    new_row['Enflasyon'] = senaryo['Aylik_Enflasyon_Ort']
    new_row['Faiz'] = senaryo['Faiz_Politikasi']
    new_row['Rezervler'] = last_row['Rezervler'] * (1 + senaryo['Rezerv_Degisim_Ort']/100)
    new_row['CDS'] = last_row['CDS'] * (1 + senaryo['CDS_Degisim_Ort']/100)
    new_row['DXY'] = last_row['DXY'] 
    
    new_row['Reel_Faiz_Farki'] = new_row['Faiz'] - new_row['Enflasyon']
    
    new_row['Rezerv_Degisim'] = senaryo['Rezerv_Degisim_Ort']
    new_row['CDS_Degisim'] = senaryo['CDS_Degisim_Ort']
    new_row['DXY_Degisim'] = senaryo['DXY_Degisim_Ort']
    
    new_row['Enflasyon_Lag1'] = last_row['Enflasyon']
    new_row['Reel_Faiz_Lag1'] = last_row['Reel_Faiz_Farki']
    
    if 'Tahmin_Getiri' in last_row:
        prev_return = last_row['Tahmin_Getiri'] 
    else:
        prev_return = last_row['Dolar_TL'] / prev_row['Dolar_TL'] - 1 
        prev_return *= 100

    new_row['Dolar_Getiri_Lag2'] = df_future['Dolar_Getiri_1Ay'].iloc[-2]

    new_row['Volatilite'] = last_row['Volatilite'] * 0.98 
    
    current_sim_price = last_row['Dolar_TL']
    sma_3 = (current_sim_price + df_future['Dolar_TL'].iloc[-2] + df_future['Dolar_TL'].iloc[-3]) / 3
    new_row['Momentum_Farki'] = current_sim_price - sma_3

    row_df = pd.DataFrame([new_row], index=[current_date])
    
    X_future = row_df[features]
    
    pred_pct = model.predict(X_future)[0]
    
    new_price = last_row['Dolar_TL'] * (1 + pred_pct / 100)
    
    row_df['Dolar_TL'] = new_price
    row_df['Tahmin_Getiri'] = pred_pct 
    row_df['Dolar_Getiri_1Ay'] = pred_pct 
    
    df_future = pd.concat([df_future, row_df])
    
    print(f"{current_date.strftime('%Y-%m')}: Tahmin: {new_price:.2f} TL (Artış: %{pred_pct:.2f})")

jan_2026_price = df_future.loc['2026-01-01', 'Dolar_TL']
print(f"\n========================================")
print(f"MODELİN 2026 OCAK TAHMİNİ: {jan_2026_price:.2f} TL")
print(f"========================================")

plt.figure(figsize=(12, 6))
plt.plot(df_model.index, df_model['Dolar_TL'], label='Gerçekleşen', color='blue')
future_part = df_future[df_future.index > df_model.index[-1]]
plt.plot(future_part.index, future_part['Dolar_TL'], label='2026 Projeksiyonu', color='red', linestyle='--', marker='o')

plt.title(f'2026 Ocak Hedefli Dolar Kuru Simülasyonu\n(Senaryo: Enflasyon %{senaryo["Aylik_Enflasyon_Ort"]}, Faiz %{senaryo["Faiz_Politikasi"]})')
plt.grid(True, alpha=0.3)
plt.legend()
plt.show()

import matplotlib.dates as mdates

df_2025 = df_future.loc['2025-01-01':'2025-12-01']

dates_focus = ['2025-11-01', '2025-12-01', '2026-01-01']
df_focus = df_future.loc[df_future.index.isin(dates_focus)]

fig, axes = plt.subplots(1, 2, figsize=(18, 6))

axes[0].plot(df_2025.index, df_2025['Dolar_TL'], marker='o', color='tab:blue', linewidth=2)
axes[0].set_title("2025 Yılı Dolar Kuru Projeksiyonu", fontsize=14)
axes[0].set_ylabel("Dolar Kuru (TL)")
axes[0].grid(True, alpha=0.3)

axes[0].xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m'))
axes[0].xaxis.set_major_locator(mdates.MonthLocator())
plt.setp(axes[0].xaxis.get_majorticklabels(), rotation=45)

axes[1].plot(df_focus.index, df_focus['Dolar_TL'], marker='s', markersize=10, color='tab:red', linewidth=3, linestyle='--')
axes[1].set_title("Kritik Dönem Tahmini: Kas'25 - Oca'26", fontsize=14)
axes[1].grid(True, alpha=0.3)

# Tarih formatı
axes[1].xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m'))
axes[1].set_xticks(df_focus.index) 

for date, price in zip(df_focus.index, df_focus['Dolar_TL']):
    label = f"{price:.2f} TL"
    axes[1].annotate(label, 
                     (date, price), 
                     textcoords="offset points", 
                     xytext=(0,15), 
                     ha='center', 
                     fontsize=12, 
                     fontweight='bold',
                     bbox=dict(boxstyle="round,pad=0.3", fc="white", ec="red", alpha=0.8))

plt.tight_layout()
plt.show()

print("\n--- İSTENEN DÖNEM TAHMİNLERİ ---")
for date, row in df_focus.iterrows():
    print(f"{date.strftime('%Y %B')}: {row['Dolar_TL']:.2f} TL")

